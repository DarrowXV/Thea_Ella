<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Fun v3.2</title>
    <style>
        :root {
            --primary: #4A90E2;
            --accent: #FF6B6B;
            --bg: #F0F4F8;
            --card: #ffffff;
            --text: #333333;
            --success: #2ECC71;
            --hint-bg: #FFF3CD;
            --hint-text: #856404;
        }

        body {
            font-family: 'Comic Sans MS', 'Comic Neue', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation; 
        }

        .container {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
            padding-bottom: 30px; /* Space for version number */
        }

        h1 { margin: 0 0 15px 0; color: var(--primary); }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-thea { background-color: #9B59B6; }
        .btn-ella { background-color: #2ECC71; }
        .btn-submit { background-color: var(--primary); font-size: 1.5rem; }
        .btn-clear { background-color: #95a5a6; width: auto; display: inline-block; padding: 5px 15px; font-size: 0.9rem; margin-top: 5px;}
        
        .toggle-draw { background: #f1c40f; color: #333; margin-bottom: 5px; }
        .btn-teach { background: #E67E22; color: white; margin-bottom: 15px; }

        /* Game Elements */
        .header-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .streak-box { color: #e67e22; font-weight: bold; }

        .question-box { font-size: 3rem; margin: 10px 0; font-weight: bold; }

        input[type="number"] {
            width: 140px;
            height: 60px;
            font-size: 2.5rem;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            margin-bottom: 15px;
            outline: none;
        }
        input[type="number"]:focus { border-color: var(--primary); }

        /* Teach Me Box */
        #teach-box {
            display: none;
            background-color: var(--hint-bg);
            color: var(--hint-text);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: left;
            border: 1px solid #ffeeba;
        }
        .dot {
            height: 15px; width: 15px;
            background-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            margin: 2px;
        }
        .vertical-math {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1.2;
            margin: 10px 0;
            display: inline-block;
            text-align: right;
        }
        
        /* Stickers Area */
        #sticker-area {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #eee;
            min-height: 50px;
        }
        .sticker { font-size: 2rem; margin: 5px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* Scratchpad Canvas */
        #scratch-container {
            display: none;
            margin-top: 15px;
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            background: #fff;
            position: relative;
        }
        
        canvas {
            touch-action: none; 
            width: 100%;
            height: 250px;
            border-radius: 10px;
            cursor: crosshair;
        }

        .version {
            position: absolute;
            bottom: 5px;
            right: 15px;
            color: #bdc3c7;
            font-size: 0.8rem;
            font-family: sans-serif;
        }

        .hidden { display: none !important; }
        .feedback { height: 25px; font-weight: bold; font-size: 1.2rem; margin-top: 10px; }
        .correct { color: var(--success); }
        .wrong { color: var(--accent); }

    </style>
</head>
<body>

    <div class="container" id="main-card">
        <div id="profile-select">
            <h1>Math Time! üéì</h1>
            <p>Select your profile:</p>
            <button class="btn btn-thea" onclick="startGame('Thea')">Thea (Age 10)</button>
            <button class="btn btn-ella" onclick="startGame('Ella')">Ella (Age 7)</button>
        </div>

        <div id="game-area" class="hidden">
            <div class="header-bar">
                <span onclick="goHome()" style="cursor:pointer">‚¨Ö Menu</span>
                <span class="streak-box">üî• Streak: <span id="streak">0</span></span>
            </div>
            
            <div class="question-box" id="question">2 + 2</div>

            <button class="btn btn-teach" onclick="toggleTeach()">üí° Teach Me How</button>
            <div id="teach-box"></div>

            <input type="number" id="answer-input" placeholder="?" pattern="\d*">
            
            <button class="btn btn-submit" onclick="checkAnswer()">Check Answer</button>
            <div class="feedback" id="feedback"></div>
            
            <div id="sticker-area">
                <div style="font-size: 0.9rem; color: #aaa; margin-bottom: 5px;">Your Stickers (Get 5 in a row!)</div>
                <div id="stickers"></div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <button class="btn toggle-draw" onclick="toggleScratchpad()">‚úèÔ∏è Show Scratchpad</button>
            
            <div id="scratch-container">
                <canvas id="drawing-board"></canvas>
                <div style="text-align: right; padding: 5px;">
                    <button class="btn btn-clear" onclick="clearCanvas()">Clear Pad</button>
                </div>
            </div>
        </div>

        <div class="version">v3.2</div>
    </div>

    <script>
        // GAME STATE
        let currentProfile = '';
        let streak = 0;
        
        // Current Question Data
        let qNum1 = 0;
        let qNum2 = 0;
        let qOperator = '';
        let qAnswer = 0;
        
        // Sticker Collection
        const stickers = ['‚≠ê', 'ü¶Ñ', 'ü¶ñ', 'üöÄ', 'üåà', 'üç¶', 'üç©', 'ü¶ã', 'üêº', 'üê±', 'üê∂', 'üê∏', 'üê®', 'ü§ñ', 'üëæ', 'üéÉ', '‚öΩ', 'üé®'];

        const profileScreen = document.getElementById('profile-select');
        const gameScreen = document.getElementById('game-area');
        const streakEl = document.getElementById('streak');
        const questionEl = document.getElementById('question');
        const inputEl = document.getElementById('answer-input');
        const feedbackEl = document.getElementById('feedback');
        const scratchContainer = document.getElementById('scratch-container');
        const teachBox = document.getElementById('teach-box');
        const stickersContainer = document.getElementById('stickers');

        // CANVAS SETUP
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#333';
        }
        window.addEventListener('resize', resizeCanvas);

        function startGame(name) {
            currentProfile = name;
            streak = 0;
            streakEl.innerText = '0';
            stickersContainer.innerHTML = ''; 
            
            profileScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setTimeout(resizeCanvas, 50);
            generateQuestion();
        }

        function goHome() {
            gameScreen.classList.add('hidden');
            profileScreen.classList.remove('hidden');
            inputEl.value = '';
            feedbackEl.innerText = '';
            clearCanvas();
            scratchContainer.style.display = 'none';
            teachBox.style.display = 'none';
        }

        function toggleScratchpad() {
            if (scratchContainer.style.display === 'block') {
                scratchContainer.style.display = 'none';
            } else {
                scratchContainer.style.display = 'block';
                resizeCanvas();
            }
        }
        
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        // --- UPDATED TEACHING LOGIC ---
        function toggleTeach() {
            if (teachBox.style.display === 'block') {
                teachBox.style.display = 'none';
                return;
            }
            
            teachBox.style.display = 'block';
            let html = '';

            // Visuals for Ella (and small numbers for Thea)
            if (currentProfile === 'Ella' || (currentProfile === 'Thea' && qNum1 < 10 && qOperator !== '√ó')) {
                if (qOperator === '+') {
                    html += `<p>Here are the groups. Can you count them all?</p>`;
                    for(let i=0; i<qNum1; i++) html += `<span class="dot"></span>`;
                    html += ` ‚ûï `;
                    for(let i=0; i<qNum2; i++) html += `<span class="dot" style="background-color:#F1C40F"></span>`;
                } else if (qOperator === '-') {
                    html += `<p>Here are <b>${qNum1}</b> dots.</p>`;
                    for(let i=0; i<qNum1; i++) html += `<span class="dot"></span>`;
                    html += `<p>Put your finger over <b>${qNum2}</b> of them. How many are left?</p>`;
                }
            } 
            // Strategies for Thea (Updated for v3.2)
            else {
                if (qOperator === '+') {
                    html += `<strong>Split Strategy:</strong><br>`;
                    html += `1. Add the Tens: <b>${Math.floor(qNum1/10)*10} + ${Math.floor(qNum2/10)*10} = ?</b><br>`;
                    html += `2. Add the Ones: <b>${qNum1%10} + ${qNum2%10} = ?</b><br>`;
                    html += `3. Add those answers together.`;
                } 
                else if (qOperator === '-') {
                    // NEW: Column Subtraction Hint
                    html += `<strong>Column Method:</strong><br>`;
                    html += `Use the scratchpad to write it like this:<br>`;
                    html += `<div class="vertical-math">
                             &nbsp;&nbsp;${qNum1}<br>
                             - ${qNum2}<br>
                             -----
                             </div><br>`;
                    html += `1. Subtract the Ones: <b>${qNum1%10} - ${qNum2%10}</b><br>`;
                    html += `2. Subtract the Tens: <b>${Math.floor(qNum1/10)} - ${Math.floor(qNum2/10)}</b>`;
                } 
                else if (qOperator === '√ó') {
                    html += `<strong>Skip Counting:</strong><br>`;
                    html += `Count by <b>${qNum2}</b>, <b>${qNum1}</b> times.<br>`;
                    html += `<i>Ex: ${qNum2}, ${qNum2*2}, ${qNum2*3}... keep going!</i>`;
                } else if (qOperator === '√∑') {
                    html += `<strong>Reverse It:</strong><br>`;
                    html += `Ask yourself: <br>`;
                    html += `‚ùì √ó <b>${qNum2}</b> = <b>${qNum1}</b>`;
                }
            }
            
            teachBox.innerHTML = html;
        }


        // --- MATH GENERATION ---
        function generateQuestion() {
            inputEl.value = '';
            inputEl.focus();
            feedbackEl.innerText = '';
            teachBox.style.display = 'none'; 
            
            if (currentProfile === 'Ella') {
                if (Math.random() > 0.4) {
                    qOperator = '+';
                    qNum1 = Math.floor(Math.random() * 10) + 1; 
                    qNum2 = Math.floor(Math.random() * 10) + 1; 
                    qAnswer = qNum1 + qNum2;
                } else {
                    qOperator = '-';
                    qNum1 = Math.floor(Math.random() * 10) + 5; 
                    qNum2 = Math.floor(Math.random() * (qNum1 - 2)) + 1;
                    qAnswer = qNum1 - qNum2;
                }
            } else {
                const type = Math.random();
                if (type < 0.25) { 
                    qOperator = '+';
                    qNum1 = Math.floor(Math.random() * 80) + 10; 
                    qNum2 = Math.floor(Math.random() * 80) + 10;
                    qAnswer = qNum1 + qNum2;
                } else if (type < 0.5) {
                    qOperator = '-';
                    // Generate numbers specifically good for non-borrowing column practice first
                    // but allow harder ones too.
                    qNum1 = Math.floor(Math.random() * 90) + 20;
                    qNum2 = Math.floor(Math.random() * (qNum1 - 10)) + 5;
                    qAnswer = qNum1 - qNum2;
                } else if (type < 0.8) {
                    qOperator = '√ó';
                    qNum1 = Math.floor(Math.random() * 10) + 2; 
                    qNum2 = Math.floor(Math.random() * 10) + 2;
                    qAnswer = qNum1 * qNum2;
                } else {
                    qOperator = '√∑';
                    qNum2 = Math.floor(Math.random() * 9) + 2; 
                    qAnswer = Math.floor(Math.random() * 10) + 1; 
                    qNum1 = qAnswer * qNum2; 
                }
            }
            questionEl.innerText = `${qNum1} ${qOperator} ${qNum2}`;
        }

        function checkAnswer() {
            const userVal = parseInt(inputEl.value);
            if (isNaN(userVal)) return;

            if (userVal === qAnswer) {
                streak++;
                streakEl.innerText = streak;
                feedbackEl.innerText = "Correct! üéâ";
                feedbackEl.className = "feedback correct";
                
                if (streak > 0 && streak % 5 === 0) {
                    addSticker();
                    feedbackEl.innerText = "Correct! NEW STICKER! üéÅ";
                }

                setTimeout(generateQuestion, 1200);
            } else {
                streak = 0;
                streakEl.innerText = streak;
                feedbackEl.innerText = "Try again! ‚ùå";
                feedbackEl.className = "feedback wrong";
                inputEl.value = '';
                inputEl.focus();
            }
        }
        
        function addSticker() {
            const sticker = stickers[Math.floor(Math.random() * stickers.length)];
            const span = document.createElement('span');
            span.className = 'sticker';
            span.innerText = sticker;
            stickersContainer.appendChild(span);
        }

        inputEl.addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkAnswer();
        });

        // DRAWING HANDLERS
        function startDraw(e) { isDrawing = true; draw(e); }
        function endDraw() { isDrawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, {passive: false});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive: false});

    </script>
</body>
</html>
